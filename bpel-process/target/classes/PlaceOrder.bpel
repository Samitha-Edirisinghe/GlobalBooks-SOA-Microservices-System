<?xml version="1.0" encoding="UTF-8"?>
<process name="PlaceOrderProcess"
         targetNamespace="http://globalbooks.com/bpel/placeorder/"
         xmlns="http://docs.oasis-open.org/wsbpel/2.0/process/executable"
         xmlns:tns="http://globalbooks.com/bpel/placeorder/"
         xmlns:cat="http://catalog.globalbooks.com/"
         xmlns:ord="http://orders.globalbooks.com/"
         xmlns:xsd="http://www.w3.org/2001/XMLSchema">

    <!-- Import WSDLs -->
    <import importType="http://schemas.xmlsoap.org/wsdl/" 
            location="CatalogService.wsdl" 
            namespace="http://catalog.globalbooks.com/"/>
    <import importType="http://schemas.xmlsoap.org/wsdl/" 
            location="OrdersService.wsdl" 
            namespace="http://orders.globalbooks.com/"/>

    <!-- Partner Links -->
    <partnerLinks>
        <partnerLink name="customer" 
                    partnerLinkType="tns:PlaceOrderLT" 
                    myRole="PlaceOrderService"/>
        <partnerLink name="catalogService" 
                    partnerLinkType="cat:CatalogLT" 
                    partnerRole="CatalogService"/>
        <partnerLink name="ordersService" 
                    partnerLinkType="ord:OrdersLT" 
                    partnerRole="OrdersService"/>
    </partnerLinks>

    <!-- Variables -->
    <variables>
        <!-- Input/output variables -->
        <variable name="orderRequest" messageType="tns:PlaceOrderRequestMessage"/>
        <variable name="orderResponse" messageType="tns:PlaceOrderResponseMessage"/>
        
        <!-- Catalog service variables -->
        <variable name="catalogRequest" messageType="cat:GetBookPriceRequest"/>
        <variable name="catalogResponse" messageType="cat:GetBookPriceResponse"/>
        
        <!-- Orders service variables -->
        <variable name="ordersRequest" messageType="ord:CreateOrderRequest"/>
        <variable name="ordersResponse" messageType="ord:CreateOrderResponse"/>
    </variables>

    <!-- Sequence of activities -->
    <sequence>
        <!-- Receive initial order request -->
        <receive partnerLink="customer" 
                portType="tns:PlaceOrderPT" 
                operation="placeOrder" 
                variable="orderRequest" 
                createInstance="yes"/>
        
        <!-- For each item in the order, get price from catalog service -->
        <forEach counterName="itemIndex" 
                parallel="no">
            <startCounterValue>1</startCounterValue>
            <finalCounterValue>3</finalCounterValue> <!-- Example: fixed to 3 items -->
            <scope>
                <!-- Prepare catalog request -->
                <assign>
                    <copy>
                        <from variable="orderRequest" part="items" query="/items/item[$itemIndex]/isbn"/>
                        <to variable="catalogRequest" part="parameters" query="/cat:getBookPriceRequest/cat:isbn"/>
                    </copy>
                </assign>
                
                <!-- Call catalog service -->
                <invoke partnerLink="catalogService" 
                       portType="cat:CatalogPT" 
                       operation="getBookPrice" 
                       inputVariable="catalogRequest" 
                       outputVariable="catalogResponse"/>
                
                <!-- Store price for later use -->
                <assign>
                    <copy>
                        <from variable="catalogResponse" part="parameters" query="/cat:getBookPriceResponse/cat:return"/>
                        <to variable="orderRequest" part="items" query="/items/item[$itemIndex]/price"/>
                    </copy>
                </assign>
            </scope>
        </forEach>
        
        <!-- Calculate total amount -->
        <assign>
            <copy>
                <from expression="sum($orderRequest.items/item/price * $orderRequest.items/item/quantity)"/>
                <to variable="ordersRequest" part="parameters" query="/ord:createOrderRequest/ord:totalAmount"/>
            </copy>
            <copy>
                <from variable="orderRequest" part="customerId"/>
                <to variable="ordersRequest" part="parameters" query="/ord:createOrderRequest/ord:customerId"/>
            </copy>
            <copy>
                <from variable="orderRequest" part="items"/>
                <to variable="ordersRequest" part="parameters" query="/ord:createOrderRequest/ord:items"/>
            </copy>
        </assign>
        
        <!-- Call orders service -->
        <invoke partnerLink="ordersService" 
               portType="ord:OrdersPT" 
               operation="createOrder" 
               inputVariable="ordersRequest" 
               outputVariable="ordersResponse"/>
        
        <!-- Prepare response -->
        <assign>
            <copy>
                <from variable="ordersResponse" part="parameters" query="/ord:createOrderResponse/ord:orderId"/>
                <to variable="orderResponse" part="orderId"/>
            </copy>
            <copy>
                <from variable="ordersResponse" part="parameters" query="/ord:createOrderResponse/ord:status"/>
                <to variable="orderResponse" part="status"/>
            </copy>
        </assign>
        
        <!-- Send response -->
        <reply partnerLink="customer" 
              portType="tns:PlaceOrderPT" 
              operation="placeOrder" 
              variable="orderResponse"/>
    </sequence>
</process>